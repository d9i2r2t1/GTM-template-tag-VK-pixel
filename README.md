# Важно
**Если на сайте уже установлен пиксель ВКонтакте и настроены события (т.е. не только Pageview) - необходимо настроить инициализацию старого пикселя перед каждым событием.**

Пример:  
Настроено событие начала заполнения формы:
```js
VK.Retargeting.Event('form-fill-started');
```
Необходимо добавить к нему инициализацию пикселя:
```js
VK.Retargeting.Init('ID пикселя');
VK.Retargeting.Event('form-fill-started');
```
Если события не настроены, или вы хотите с помощью данного шаблона передавать события в уже установленный на сайте пиксель ВКонтакте - настраивать инициализацию перед каждым событием не нужно.
    

# Настройка GTM-тега
В качестве примера создадим два GTM-тега динамического ретаргетинга «ВКонтакте» с помощью данного шаблона: Pageview и AddToCart. Другие теги событий ecommerce настраиваются аналогично показанному в README тегу AddToCart.

Полную статью про создание данного шаблона можно почитать [тут](https://ppc.world/articles/polzovatelskie-shablony-v-gtm-razbiraemsya-na-primere/).

## Pageview
Зайдем в нужный контейнер GTM, создаем новый тег, тип тега выбираем VK Pixel в разделе Custom:
![Настройка, шаг 1](https://ppc.world/uploads/article_images/2019/06/customtemplates/22_nastroyka.png)

Заполняем название тега, отслеживаемое событие выбираем Hit (это стандартный pageview), в поле «ID пикселей» через запятую указываем ID двух пикселей, в которые будут отправляться данные, и ставим триггер All Pages:
![Название](https://ppc.world/uploads/article_images/2019/06/customtemplates/23_trigger.png) 

Сохраняем созданный тег.

## AddToCart
Создание тега для события добавления товара в корзину будет немного посложнее, чем тега Hit.

Во-первых, необходимо передавать товар, который добавляется в корзину. Это возможно при настроенной на сайте расширенной электронной торговле Google. В таком случае данные о товаре берутся из dataLayer.

Для этого нам надо создать в GTM переменную dataLayer, которая будет хранить в себе объект ecommerce для события addToCart. Настройки переменной выглядят вот так:
![Настройки переменной](https://ppc.world/uploads/article_images/2019/06/customtemplates/24_addtocard.png)

Во-вторых, нужно создать триггер, который будет активировать тег при наступлении события ecommerce addToCart (триггер будет активировать тег при пуше в dataLayer при событии addToCart):
![Создание триггера](https://ppc.world/uploads/article_images/2019/06/customtemplates/25_trigger_dlya_addtocard.png)

Для других событий ecommerce необходимо создать переменные и триггеры со следующими значениями:

Событие | Описание | Значение переменной dataLayer | Триггер
--------|----------|-------------------------------|------------
View Home | Просмотр главной страницы сайта | ecommerce.impressions | Триггер на событие ecommerce impressions и URL = главной странице
View Category | Просмотр страницы каталога сайта | ecommerce.impressions | Триггер на событие ecommerce impressions и URL = странице каталога
View Search | Просмотр страницы с результатами поиска по сайту | ecommerce.impressions | Триггер на событие ecommerce impressions и URL = странице с результатами поиска по сайту
View Other | Просмотр остальных страниц сайта | ecommerce.impressions | Триггер на событие ecommerce impressions и URL не равен главной странице, странице каталога и странице с результатами поиска по сайту
View Product | Просмотр детальной страницы товара | ecommerce.detail | Триггер на событие ecommerce detail 
Add To Cart | Добавление в корзину | ecommerce.add | Триггер на событие ecommerce add 
Remove From Cart | Удаление из корзины | ecommerce.remove | Триггер на событие ecommerce remove 
Init Checkout | Начало оформление заказа | ecommerce.checkout | Триггер на событие ecommerce checkout 
Purchase | Успешный заказ | ecommerce.purchase | Триггер на событие ecommerce purchase 

Для события View Search (просмотр страницы с результатами поиска по сайту) так же можно указать параметр URL, в который передается поисковый запрос пользователя. Например: https://example.ru/search?query=iphone - в данном примере параметр query хранит в себе поисковый запрос пользователя, этот параметр и нужно указывать.

После создания переменной с объектом ecommerce и триггера можно приступать к созданию тега:
![Создание тега](https://ppc.world/uploads/article_images/2019/06/customtemplates/26_sozdanie_tega.png)

По порядку:

1. В качестве отслеживаемого события выбираем Add To Cart.
2. Заполняем через запятую ID двух пикселей, в которые необходимо передавать данные.
3. Устанавливаем флажок «Использовать несколько прайс-листов»: для Москвы и Петербурга в нашем примере необходимо использовать разные прайс-листы.
4. Заполняем таблицу с прайс-листами.
5. Устанавливливаем флажок «Использовать ecommerce для передачи товаров и параметров».
6. В объекте ecommerce этого события указываем созданную ранее переменную.
7. Устанавливаем триггер на отслеживаемое событие, в этом случае — AddToCart.
8. Сохраняем.

# Проверка отработки
Для проверки отработки пикселей динамического ретаргетинга «ВКонтакте» нужно активировать режим Preview в GTM, перейти на наш сайт и открыть раздел Network в консоли браузера и в поле Filter ввести ‘rtrg’:
![Проверка в консоли](https://ppc.world/uploads/article_images/2019/06/customtemplates/27_proverka_v_konsoli.png)

После этого обновляем страницу, и у нас должно появиться два запроса — событие Hit, отправленное в два пикселя:
![Событие Hit](https://ppc.world/uploads/article_images/2019/06/customtemplates/28_hit.png)

Status 200 означает, что запросы отправлены и получены сервером успешно.

Также в окне Preview GTM видим, что наш созданный тег корректно сработал на событие Page View.

Для проверки события Add To Cart добавляем товар в корзину, и в консоли у нас появляется еще два запроса:
![Проверка события AddtoCart](https://ppc.world/uploads/article_images/2019/06/customtemplates/29_addtocard.png)

В окне Preview GTM видим, что второй тег отработал успешно. Данные о товаре из dataLayer подтянулись и обработались корректно, также подставился корректный прайс-лист.

Для второго хоста прайс-лист также подставляется корректно:
![Хост](https://ppc.world/uploads/article_images/2019/06/customtemplates/30_korrektno.png)
 
Теги для других событий настраиваются и проверяются аналогично.
